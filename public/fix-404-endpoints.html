<!DOCTYPE html>
<html>
<head>
    <title>Fix Custom Endpoint 404 Issues</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üîß Fix Custom Endpoint 404 Issues</h1>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Problem Identified</h2>
            <p class="text-yellow-700">
                Endpoint <strong>"timestamp"</strong> sudah tidak tersedia di BPJS API (returns 404). 
                Custom endpoints dengan URL yang salah juga bisa menyebabkan error 404.
            </p>
        </div>

        <!-- Step 1: Clean localStorage -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Step 1: Clean LocalStorage</h2>
            <div class="space-y-3">
                <button onclick="clearAllCustomEndpoints()" 
                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    Clear All Custom Endpoints
                </button>
                <button onclick="loadAndShowCustomEndpoints()" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Show Current Custom Endpoints
                </button>
            </div>
            <div id="customEndpointsList" class="mt-4"></div>
        </div>

        <!-- Step 2: Add Valid Endpoints -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Step 2: Add Pre-tested Valid Endpoints</h2>
            <p class="text-gray-600 mb-4">Endpoint berikut sudah ditest dan dipastikan berfungsi:</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button onclick="addValidEndpoint('Procedure 001', 'https://apijkn.bpjs-kesehatan.go.id/vclaim-rest/referensi/procedure/001', 'Referensi data prosedur medis')" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-left">
                    ‚úÖ Add Procedure 001
                </button>
                <button onclick="addValidEndpoint('Dokter DPJP', 'https://apijkn.bpjs-kesehatan.go.id/vclaim-rest/referensi/dokter/pelayanan/1/tglPelayanan/2025-07-31/Spesialis/INT', 'Dokter penanggung jawab pelayanan')" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-left">
                    ‚úÖ Add Dokter DPJP
                </button>
                <button onclick="addValidEndpoint('Peserta by NIK', 'https://apijkn.bpjs-kesehatan.go.id/vclaim-rest/Peserta/nik/6304151101990001/tglSEP/2025-07-31', 'Data peserta berdasarkan NIK')" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-left">
                    ‚úÖ Add Peserta by NIK
                </button>
                <button onclick="addValidEndpoint('Peserta by NoKartu', 'https://apijkn.bpjs-kesehatan.go.id/vclaim-rest/Peserta/nokartu/0001234567890/tglSEP/2025-07-31', 'Data peserta berdasarkan nomor kartu')" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-left">
                    ‚úÖ Add Peserta by NoKartu
                </button>
            </div>
        </div>

        <!-- Step 3: Test Endpoints -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Step 3: Test Custom Endpoints</h2>
            <button onclick="testAllCustomEndpoints()" 
                    class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                Test All Custom Endpoints
            </button>
            <div id="testResults" class="mt-4 space-y-2"></div>
        </div>

        <!-- Step 4: Visit Dashboard -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Step 4: Return to Dashboard</h2>
            <p class="text-gray-600 mb-4">Setelah cleanup dan testing, kembali ke dashboard untuk melihat hasil:</p>
            <a href="/bpjs-monitoring" 
               class="inline-block px-6 py-3 bg-blue-500 text-white rounded hover:bg-blue-600">
                üöÄ Go to BPJS Monitoring Dashboard
            </a>
        </div>
    </div>

    <script>
        function clearAllCustomEndpoints() {
            if (confirm('Are you sure you want to clear ALL custom endpoints? This cannot be undone.')) {
                localStorage.removeItem('bpjs_custom_endpoints');
                localStorage.removeItem('bpjs_historical_data');
                alert('‚úÖ All custom endpoints and historical data cleared!');
                loadAndShowCustomEndpoints();
            }
        }

        function loadAndShowCustomEndpoints() {
            const stored = localStorage.getItem('bpjs_custom_endpoints');
            const listDiv = document.getElementById('customEndpointsList');
            
            if (stored) {
                try {
                    const endpoints = JSON.parse(stored);
                    if (endpoints.length === 0) {
                        listDiv.innerHTML = '<p class="text-gray-500 italic">No custom endpoints found</p>';
                        return;
                    }
                    
                    let html = '<div class="space-y-2"><h3 class="font-semibold">Current Custom Endpoints:</h3>';
                    endpoints.forEach((endpoint, index) => {
                        html += `
                            <div class="p-3 border rounded bg-gray-50">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-medium">${endpoint.name}</h4>
                                        <p class="text-sm text-gray-600">${endpoint.url}</p>
                                        <p class="text-xs text-gray-500">${endpoint.description || 'No description'}</p>
                                    </div>
                                    <button onclick="deleteCustomEndpoint(${index})" 
                                            class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    listDiv.innerHTML = html;
                    
                } catch (e) {
                    listDiv.innerHTML = '<p class="text-red-500">Error parsing localStorage data</p>';
                }
            } else {
                listDiv.innerHTML = '<p class="text-gray-500 italic">No custom endpoints found</p>';
            }
        }

        function deleteCustomEndpoint(index) {
            const stored = localStorage.getItem('bpjs_custom_endpoints');
            if (stored) {
                try {
                    const endpoints = JSON.parse(stored);
                    endpoints.splice(index, 1);
                    localStorage.setItem('bpjs_custom_endpoints', JSON.stringify(endpoints));
                    loadAndShowCustomEndpoints();
                    alert('‚úÖ Endpoint deleted!');
                } catch (e) {
                    alert('‚ùå Error deleting endpoint');
                }
            }
        }

        function addValidEndpoint(name, url, description) {
            const stored = localStorage.getItem('bpjs_custom_endpoints');
            let endpoints = [];
            
            if (stored) {
                try {
                    endpoints = JSON.parse(stored);
                } catch (e) {
                    endpoints = [];
                }
            }
            
            // Check if endpoint already exists
            const exists = endpoints.some(ep => ep.url === url);
            if (exists) {
                alert('‚ö†Ô∏è Endpoint already exists!');
                return;
            }
            
            const newEndpoint = {
                id: Date.now().toString(),
                name: name,
                url: url,
                description: description,
                method: 'GET',
                headers: {},
                timeout: 15,
                isActive: true,
                isBpjsEndpoint: url.includes('bpjs-kesehatan.go.id'),
                useProxy: url.includes('bpjs-kesehatan.go.id')
            };
            
            endpoints.push(newEndpoint);
            localStorage.setItem('bpjs_custom_endpoints', JSON.stringify(endpoints));
            loadAndShowCustomEndpoints();
            alert(`‚úÖ Added: ${name}`);
        }

        async function testAllCustomEndpoints() {
            const stored = localStorage.getItem('bpjs_custom_endpoints');
            const resultsDiv = document.getElementById('testResults');
            
            if (!stored) {
                resultsDiv.innerHTML = '<p class="text-gray-500">No custom endpoints to test</p>';
                return;
            }
            
            try {
                const endpoints = JSON.parse(stored);
                if (endpoints.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-gray-500">No custom endpoints to test</p>';
                    return;
                }
                
                resultsDiv.innerHTML = '<p class="text-blue-600">Testing endpoints...</p>';
                
                let html = '<div class="space-y-2">';
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch('/bpjs-monitoring/test-custom-endpoint', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                            },
                            body: JSON.stringify({
                                url: endpoint.url,
                                method: endpoint.method || 'GET',
                                timeout: endpoint.timeout || 15
                            })
                        });

                        const result = await response.json();
                        
                        const statusClass = result.status === 'success' ? 'bg-green-50 border-green-200' : 
                                          result.status === 'timeout' ? 'bg-yellow-50 border-yellow-200' : 
                                          'bg-red-50 border-red-200';
                        
                        html += `
                            <div class="p-3 border rounded ${statusClass}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-medium">${endpoint.name}</h4>
                                        <p class="text-sm">Status: ${result.status} | Code: ${result.code} | Time: ${result.response_time}ms</p>
                                        <p class="text-xs text-gray-600">${result.message}</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs rounded ${
                                        result.status === 'success' ? 'bg-green-100 text-green-800' :
                                        result.status === 'timeout' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800'
                                    }">${result.status}</span>
                                </div>
                            </div>
                        `;
                        
                    } catch (error) {
                        html += `
                            <div class="p-3 border rounded bg-red-50 border-red-200">
                                <h4 class="font-medium">${endpoint.name}</h4>
                                <p class="text-sm text-red-600">Error: ${error.message}</p>
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (e) {
                resultsDiv.innerHTML = '<p class="text-red-500">Error testing endpoints</p>';
            }
        }

        // Load endpoints on page load
        window.onload = function() {
            loadAndShowCustomEndpoints();
        };
    </script>
</body>
</html>
