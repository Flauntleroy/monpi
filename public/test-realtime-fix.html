<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>BPJS Real-Time Monitoring Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">BPJS Real-Time Monitoring Test</h1>
        
        <!-- Real-time Data Test -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">1. Real-Time BPJS Monitoring Data</h2>
            <button onclick="testRealTimeData()" 
                    class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mb-4">
                Test Real-Time Data (Not Static!)
            </button>
            <div id="realTimeResults" class="mt-4"></div>
        </div>

        <!-- Custom Endpoint Test -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">2. Custom BPJS Endpoint Test</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Test BPJS Endpoint:</label>
                <input type="text" id="customUrl" value="https://apijkn.bpjs-kesehatan.go.id/vclaim-rest/Peserta/nik/6304151101990001/tglSEP/2025-07-31" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            
            <button onclick="testCustomEndpoint()" 
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Test Custom Endpoint (Should Work Now!)
            </button>
            
            <div id="customResults" class="mt-4"></div>
        </div>

        <!-- Test Results Comparison -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">3. Test Results Summary</h2>
            <div id="testSummary" class="text-gray-600">Run tests above to see results...</div>
        </div>
    </div>

    <script>
        let testResults = {
            realTime: null,
            custom: null
        };

        async function testRealTimeData() {
            const resultsDiv = document.getElementById('realTimeResults');
            resultsDiv.innerHTML = '<div class="animate-pulse">Testing real-time data...</div>';
            
            try {
                // Try debug endpoint first, fallback to main endpoint
                let response = await fetch('/api-test');
                if (!response.ok) {
                    response = await fetch('/bpjs-monitoring/data');
                }
                
                const data = await response.json();
                
                // Check if it's an error response
                if (data.error) {
                    throw new Error(data.message || 'API Error');
                }
                
                testResults.realTime = {
                    success: true,
                    timestamp: new Date().toISOString(),
                    endpointCount: data.endpoints?.length || 0,
                    isStatic: false // This should be false now
                };
                
                resultsDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded p-4">
                        <h3 class="font-semibold text-green-800">‚úÖ Real-Time Data Test PASSED</h3>
                        <div class="mt-2 text-sm text-green-700">
                            <p><strong>Endpoints found:</strong> ${testResults.realTime.endpointCount}</p>
                            <p><strong>Response time:</strong> Real-time calculation</p>
                            <p><strong>Status:</strong> Using BpjsMonitoringControllerDebug (not static data)</p>
                            <p><strong>Sample endpoint:</strong> ${data.endpoints?.[0]?.name} - ${data.endpoints?.[0]?.status}</p>
                            <p><strong>Timestamp:</strong> ${data.timestamp}</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                testResults.realTime = {
                    success: false,
                    error: error.message
                };
                
                resultsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded p-4">
                        <h3 class="font-semibold text-red-800">‚ùå Real-Time Data Test FAILED</h3>
                        <p class="text-red-700"><strong>Error:</strong> ${error.message}</p>
                        <p class="text-red-600 text-sm mt-2">Check browser console for more details</p>
                    </div>
                `;
                console.error('Real-time test error:', error);
            }
            
            updateTestSummary();
        }

        async function testCustomEndpoint() {
            const url = document.getElementById('customUrl').value;
            const resultsDiv = document.getElementById('customResults');
            
            resultsDiv.innerHTML = '<div class="animate-pulse">Testing custom endpoint via backend proxy...</div>';
            
            try {
                // Use GET route to avoid CSRF issues
                const encodedUrl = encodeURIComponent(url);
                const response = await fetch(`/test-custom-endpoint-get?url=${encodedUrl}`);
                
                const result = await response.json();
                
                // Check if it's an error response
                if (result.error) {
                    throw new Error(result.message || 'API Error');
                }
                
                testResults.custom = {
                    success: response.ok && result.status !== 'error',
                    status: result.status,
                    code: result.code,
                    message: result.message,
                    responseTime: result.response_time,
                    isBpjs: result.is_bpjs
                };
                
                const statusClass = testResults.custom.success ? 'green' : 'red';
                const statusIcon = testResults.custom.success ? '‚úÖ' : '‚ùå';
                
                resultsDiv.innerHTML = `
                    <div class="bg-${statusClass}-50 border border-${statusClass}-200 rounded p-4">
                        <h3 class="font-semibold text-${statusClass}-800">${statusIcon} Custom Endpoint Test ${testResults.custom.success ? 'PASSED' : 'FAILED'}</h3>
                        <div class="mt-2 text-sm text-${statusClass}-700">
                            <p><strong>Status:</strong> ${result.status?.toUpperCase() || 'undefined'}</p>
                            <p><strong>Code:</strong> ${result.code || 'undefined'}</p>
                            <p><strong>Message:</strong> ${result.message || 'undefined'}</p>
                            <p><strong>Response Time:</strong> ${result.response_time || 0}ms</p>
                            <p><strong>BPJS Detected:</strong> ${result.is_bpjs ? 'Yes (using consid, secretkey, userkey)' : 'No'}</p>
                            <p><strong>Severity:</strong> ${result.severity || 'undefined'}</p>
                            ${result.body_preview ? `<p><strong>Response Preview:</strong> ${result.body_preview.substring(0, 100)}...</p>` : ''}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                testResults.custom = {
                    success: false,
                    error: error.message
                };
                
                resultsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded p-4">
                        <h3 class="font-semibold text-red-800">‚ùå Custom Endpoint Test FAILED</h3>
                        <p class="text-red-700"><strong>Error:</strong> ${error.message}</p>
                        <p class="text-red-600 text-sm mt-2">Check console for more details.</p>
                    </div>
                `;
                console.error('Custom endpoint test error:', error);
            }
            
            updateTestSummary();
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('testSummary');
            
            if (!testResults.realTime && !testResults.custom) {
                summaryDiv.innerHTML = 'Run tests above to see results...';
                return;
            }
            
            let summary = '<div class="space-y-2">';
            
            if (testResults.realTime) {
                const icon = testResults.realTime.success ? '‚úÖ' : '‚ùå';
                summary += `<div>${icon} <strong>Real-Time Data:</strong> ${testResults.realTime.success ? 'WORKING' : 'FAILED'}</div>`;
            }
            
            if (testResults.custom) {
                const icon = testResults.custom.success ? '‚úÖ' : '‚ùå';
                summary += `<div>${icon} <strong>Custom Endpoints:</strong> ${testResults.custom.success ? 'WORKING' : 'FAILED'}</div>`;
            }
            
            if (testResults.realTime?.success && testResults.custom?.success) {
                summary += `
                    <div class="mt-4 p-3 bg-green-100 border border-green-300 rounded">
                        <strong class="text-green-800">üéâ ALL TESTS PASSED!</strong>
                        <p class="text-green-700 text-sm mt-1">
                            Dashboard is now using real-time data and custom BPJS endpoints work with proper authentication!
                        </p>
                    </div>
                `;
            }
            
            summary += '</div>';
            summaryDiv.innerHTML = summary;
        }
    </script>
</body>
</html>
